# 目录
| 任务            | 目的                                          | 功能与实现                                                                                                                                                                                                                                                | 代码路径及功能                                                                                                                                                                                                                                                                                         |
|----------------|:--------------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| OTC锁价订单与对冲订单的匹配| 分析对冲订单的盈亏情况，并分析盈亏是由什么因素造成的/能从什么角度改善         |  匹配锁价订单和对冲订单，使得二者的买卖方向、币种（quote coin）、client_id 均匹配，且base_amount 的误差在 1% 以内。                                                                                                                                                                         | order_analyse文件夹下<br/>1.get_data_from_db.py：从PostgreSQL中获取锁价数据和对冲数据。<br/>2.match_order.py：订单匹配<br/>3.analyse.py：对匹配上的订单进行对冲收益等维度的分析，并可视化                                                                                                                                                        |
| 新订单异常识别与钉钉推送 | 若新订单的对冲盈亏出现异常，钉钉预警                          | 对于新进入的OTC订单，若出现以下异常情况，则推送钉钉报警：<br/>1.损益小于历史损益的 5% 分位数或大于历史损益的 95% 分位数；<br/>2.锁价报价对冲时间差大于历史对冲时间差的95%分位数。 2. OTC新订单分析并用钉钉推送                                                                                                                            | order_analyse文件夹下：<br/>1.get_data_from_db.py：获取锁价数据和对冲数据。 <br/>2.match_order.py：订单匹配 <br/>3.push_anomalies.py：识别异常情况 <br/>4.config.json：存储参数 <br/><br/>api_and_ding文件夹下：<br/>1.ding.py：推送钉钉报警                                                                                                   |
| 锁价订单买卖匹配    | 监控客户通过买卖相同数量的同一币种从而进行套利的情况，并钉钉预警            | 对一定时间内（例如5min）输入的锁价订单进行进行同币种买卖匹配，若买卖数量相等，买卖方向相反, 就推送钉钉信息出来进行报警。                                                                                                                                                                                      | order_analyse文件夹下：<br/>1.get_data_from_db.py：获取锁价数据和对冲数据。 <br/>2.match_order_with_diff_direction.py：锁价订单买卖匹配（需要继承match_order.py中的类） <br/><br/>api_and_ding文件夹下： <br/>1.ding.py：推送钉钉报警                                                                                                           |
| OTC订单推送整合      | 整合钉钉预警的代码，便于实际执行                            | 整合新订单异常识别与钉钉推送和锁价订单买卖匹配推送的代码，每五分钟检查一次新订单情况，进行同步推送。                                                                                                                                                                                                   | order_analyse文件夹下： <br/>1.report_new_order_to_ding.py：整合新订单异常识别与钉钉推送和锁价订单买卖匹配推送的功能（实际上也需要import二者的代码）                                                                                                                                                                                           |
| 强平模拟           | 看目前的强平线设置是否合理（是否会造成损失）                      | 进行强平模拟，看在各种随机仓位和不同市场行情下，是否会触发强平线，并计算强平损失概率。                                                                                                                                                                                                          | mandatory_liquidation文件夹下：<br/>1.get_data.py：通过huobi api获取数据 <br/>2.mandatory_liquidation.py：进行模拟强平 <br/>3.paint.py：对强平结果进行可视化 <br/><br/>api_and_ding/get_market_data文件夹下： <br/>1.huobi_data.py：获取huobi交易所的行情数据                                                                                 |
| 单币种分析          | 业务需要，分析给定交易对的流动性等情况                         | 对给定的交易对，分析其在huobi、binance、okx、ftx 四个交易所的现货、永续合约交易对的行情数据，并自动生成分析报告（txt文件）。                                                                                                                                                                            | coin_analysis文件夹下：<br/>1.exchange_data.py：整合四个交易所的api数据获取 <br/>2.coin_analysis.py：对给定交易对进行统计分析并生成报告 <br/><br/>api_and_ding/get_market_data文件夹下： <br/>1.huobi_data.py：获取huobi交易所的行情数据 <br/>2.binance_data.py：获取binance交易所的行情数据 <br/>3.okx_data.py：获取okx交易所的行情数据 <br/>4.ftx_data.py：获取ftx交易所的行情数据 |
| 子母账户功能测试（部分）  | 配资借贷业务中，看母账户对子账户的管理、限制是否能正常实现               | 测试子母账户的转账、查询等功能，由于api权限问题，部分测试未完成。                                                                                                                                                                                                                   | 见subuser_test文件夹                                                                                                                                                                                                                                                               _ |
| 价格预测       | 在质押借贷自动化对冲中，预测价格是在强平线振荡还是会持续下跌，以确定是否进行做空对冲。 | 根据波动率以及动量指标来对开盘价进行预测。 </br>未找到合适的模型进行预测，未完成。                                                                                                                                                                                                         | 见price_predict文件夹                                                                                                                                                                                                                                                                |




# notes
## 一、数字货币交易
### 1. 交易对的表示 BTC/USDT
BTC/USDT 作为现货交易对， BTC 是 base coin, USDT 是 quote coin。
- base coin 
- quote coin 以什么计价的，eg买1单位base coin需要多少quote coin，类似外汇的计价货币

### 2. OTC  
客户先询价，满意就锁价。\
对冲：客户对我们进行什么操作（买/卖），我们对应交易所也做什么操作（买/卖）

交易方式有：
* twap ，代表是现货交易
* otchedge， 代表是用合约交易，卖不是马上卖，而是先做空1个btc，后续再重新平仓空头，即买入btc（用合约操作有更低的滑点（手续费影响，会存在一定的头寸？）
* alameda，代表从alameda 平台交易。alameda 是FTX交易所 的 OTC 平台, 我们去询价，并和我们的价格进行比较, 选较优值进行下单，比如说 alameda 的价格更好, 我们就直接在他们那里下单, 做二道贩子。

### 3. 算法交易
选择算法交易是希望交易不会对市场产生太大冲击，另一方面也希望交易不会因为时间的问题导致了价格变化、成本增加。
* vwap：根据对市场成交量分布的预测进行下单，降低市场冲击，最小化与市场VWAP的偏差。市场交易度分配，市场交易度是预测出来的
* twap：在设定的时间范围内，匀速下单，降低市场冲击，最小化与市场TWAP的偏差。
* 冰山：触发到了某个阈值才会交易  https://www.doc88.com/p-5304760246921.html?r=1

vwap在币圈没啥用，因为7*24交易，因而很难像证券市场一样，通过开盘、收盘等时间点的历史数据推断未来的成交量分布。

### 4. maker & taker
交易所交易都是订单簿交易 orderbook。\
上面的是 ask price(卖价), 下面的是 bid price(买价), 盘口价就是 bid 和 ask 中最优的价格。
- taker 就是直接按照最优价格进行成交；
- maker 就是你挂一个不能马上成交的单, 这个单会出现在 orderbook 中。

### 5. 数字货币 API
数字货币的数据获取比股市容易很多.\
有一个叫 ccxt 的 Python 库，封装了很多交易所的API 功能。

- api 代码实现\
key 和 secret key 不需要签名验证的，就用 requests.get(url)
- api获取时会加上 time.sleep() \
因为全是 restful 请求, 可能会有限频的问题(一定时间内访问次数有限)
- restful 和 websocket
？
一个 import requests；一个import websocket

```python
import requests

if __name__ == "__main__":
    url = "https://api.huobi.pro/market/tickers"
    test = requests.get(url)
    test = test.json()
    print(test)
```

不同交易所对不同币种的表示方式不同：eg. 火币api\
现货 btcusdt\
币本位永续 BTC-USD\
U 本位永续 BTC-USDT\
交割合约 BTC_CW/NW/CQ/NQ

#### 6. 配资借贷的母子账户
配资借贷就是客户往账户中存入一笔钱, 我们再往这个账户中打一笔钱进去借给客户, 就相当于帮客户加杠杆了。\
做配资借贷, 需要给客户提供一个账户。母账户是在我们手上的, 可以对子账户进行操作, 子账户就是提供给客户使用的, 客户可以用子账户 API key 来操作账户进行交易, 当账户可能会出现资不抵债的情况时, 我们就可以通过母账户 API 去对子账户进行接管, 避免出现亏损。
#### 7. 逐仓杠杆和全仓杠杆账户
共同点：你把自己的钱放一部分进去账户里面, 然后交易所再借你一笔钱给你加杠杆。

不同点：
- 全仓杠杆：各种各样的币都能转进去当做质押品（本质上就是配资借贷，只是展业方式不同）；
- 逐仓杠杆：只能转对应的币, 比如说 ETH 逐仓杠杆账户就只能转 ETH 或者 USDT 进去, 借也只能借 ETH 或者 USDT。

在对配资借贷的母子账户进行管理时，会设置子用户逐仓杠杆和全仓杠杆账户的交易权限（即关闭其权限），因为我们本身就是在给客户加杠杆，不能让他再去加了。

### 8. CEX交易所 和 DEX交易所
#### 8.1 CEX交易所
中心化交易所，是目前虚拟货币交易的主导，eg. 币安，火币，OKex等。\
CEX 的交易流程类似银行，用户把自己资产转入到交易所，在交易所的背书下完成币币交易，最后再把资产提取到自己的钱包。
CEX都采用订单薄撮合模式。在中心化交易所开户需要通过 KYC 认证，即上传自己的 ID 等个人资料。

**缺点**： 
- 中心化交易所受监管机构、第三方提供商和法律法规的控制。为防止洗钱，运营商需要收集其客户（KYC）的大量数据。这种规律性与加密货币的基本思想背道而驰。
#### 8.2 DEX交易所
去中心化交易所。
提供中心化交易所的核心功能，但省去了 KYC 和“转入”、“提币”的步骤，用户使用自己的地址（在 DEX 交易所申请，或者导入自己的钱包，但用户都掌握私钥）
与 DEX 的智能合约地址交易。用户自始自终都握有地址和密钥，资产完全掌握在自己手中。\
DEX 不是基于内部服务器和本身的 IT 基础设施，而是充当区块链上的去中心化应用程序（DApp）。DEX 不基于特定的生态系统，也不依赖于转移货币，并且可以
快速交换位于不同区块链上的加密货币。

**优点**：
- 更安全，不容易受到黑客攻击（分散，不易成为目标）

**缺点**：
- 效率低（每次交易都需要矿工验证）；
- 流动性低（交易者少）

### 9. 交割合约和永续合约
都是现货交易对的衍生品，类似期货合约。


### 10. 币本位和U本位合约


## 二、算法、系统、策略
### 1. Brokerage策略风控系统
总体结构：\
Brokerage前端网站 --> 风控中台接口网关（API接口） --> 数据库(Redis 或 PostgreSQL) <-- OTCglobal后台服务集群\
我们在做的：\
    OTCglobal后台服务集群：主要涉及的就是询价服务和对冲服务。



### 2. TWAP 算法交易实现
#### 2.1 算法交易简介：基于《算法交易》

#### 2.2 算法交易概况
选择算法交易是希望交易不会对市场产生太大冲击，另一方面也希望交易不会因为时间的问题导致了价格变化、成本增加。
- vwap：根据对市场成交量分布的预测进行下单，降低市场冲击，最小化与市场VWAP的偏差。市场交易度分配，市场交易度是预测出来的
- twap：在设定的时间范围内，匀速下单，降低市场冲击，最小化与市场TWAP的偏差。
- 冰山：触发到了某个阈值才会交易  https://www.doc88.com/p-5304760246921.html?r=1

vwap在币圈没啥用，因为7*24交易，因而很难像证券市场一样，通过开盘、收盘等时间点的历史数据推断未来的成交量分布。

#### 2.3 TWAP算法实现：基于《ExecutionAlgo twap算法交易实现》
包含3种子模式：
- aggressive：主动去吃盘口上的对手单，taker方式
- passive：在盘口挂单，等待对手来吃，maker方式
- progressive：混合型，taker方式 + maker方式
##### 2.3.1 progressive（以买为例）
会每隔4~6秒进行一轮拆单（之所以4~6秒随机是防止下单时间过于固定而被人发现下单意图)，而在每一轮拆单过程中又会有三种子策略逻辑，最后每一个完整的twap算法订单最大存续时间默认为4小时。

三种子策略逻辑：
1. place_on_trade（本质就是taker方式）

获取卖单盘口前5档（可调整）的价量信息，获取其中价格小于等于某个价格阈值(price_limit)的所有卖单，这个价格阈值（price_limit)以盘口中间价为基准上浮10%（可调整）
    如果存在满足条件的卖单，并且这些卖单的累计挂单量加起来超过某个阈值（threshold_vlm，参考：最后30根分钟级别k线成交量的中位数*0.01），就开始正式拆单。
具体的逻辑是遍历所有满足条件的前N档卖单，按卖单的价格进行挂单，挂单量以对应档位卖单量为参考，当总挂单量超过某个阈值(max_vlm_each_trade)就停止挂单. max_vlm_each_trade参考：(30档买量累加+30档卖量累加)/30/2

这里挂出的买单价格直接就等于盘口卖单价格，本质就是吃单taker方式
2.place_on_orderbook
    获取盘口前五档卖单和前五档买单，同时获取中间价，中间价=（买一价+卖一价）/2
    计算前五档买单的累计挂单量，和前五档卖单的累计挂单量。
    如果前五档买单的累计挂单量大于前五档卖单的累计挂单量，那么就在中间价上放上一个maker买单，挂单量为前五档买单的平均挂单量
理解：因为买方强于卖方，所以为了能尽快成交，又不想主动吃单，最合适的办法就是在中间价上挂买单
3.place_on_spread
    如果卖一价减去买一价大于某个阈值（5倍最小tick报价）就认为当前价差过大，这个时候就以买一价加上一个最小tick价格变动值，作为指定价格在盘口上挂一个测试单。等下一轮进来后，判断这个测试单是否有成交，如果没有成交就按place_on_trade同样的逻辑挂买单。
    理解是：价差过大，下个测试单判断价差过大的情况能否缓解，如果不能缓解就意味着短期流动性不好，应该赶紧吃单保证成交（但是逻辑有问题，无法完全确定）

##### 2.3.2 aggressive（以买为例）

主动吃单，如果不设置限制随意吃单，可能会导致价格上涨，产生很大的冲击成本，所以我们要设置价格天花板price_ceil。price_ceil是在卖一档价格基础上按系数往上进行一定调整，这个调整系数的大小受当前盘口点差还有最后两分钟的价格变动率影响。
    然后获取盘口所有价格小于price_ceil的卖单列表，计算这些卖单列表的总挂单量nLevelVol。获取最新的60根分钟bar,按5分钟为一个时间窗口计算成交量的指数加权平均成交量ema_vol,和5分钟成交量的标准差vol_std。以平均成交量ema_vol加上标准差vol_std作为阈值threshold，以卖单列表的总挂单量nLevelVol是否大于阈值threshold作为区分，分成两种子策略逻辑：大单逻辑与常规挂单逻辑。如果卖单列表的总挂单量nLevelVol大于阈值threshold，同时下单时间已经到，就启用大单逻辑，否则就是常规挂单逻辑。
    大单挂单逻辑：遍历盘口所有价格小于price_ceil的卖单列表的前五个档位的卖单，以每个档位的卖单的价格和挂单量挂买单，每一轮大单挂单逻辑时间间隔为一个变量，这个变量的表达式为min(5*max(1,nlevelVol/ema.vol),60)，大小取决于卖单列表的总挂单量nLevelVol与平均成交量ema_vol的比值，但是最大不能超过（含）60秒

常规挂单逻辑：当时间达到挂单时间，将以盘口卖单第一档的价格和数量挂买单，每一轮常规挂单逻辑时间间隔不能低于30秒


最后对于每一轮没有成交的订单将会在下一轮尝试撤单，撤单条件：
    1.订单过了超时时间要撤单，超时时间为5秒，不设置的话默认300秒
    2.价格过分远离当前成交价：
    对于买单：订单价格小于第五档位的买价
    对于卖单：订单价格大于第五档位的卖价

## 三、区块链
基于哈希算法的，由指针串联起来的由区块组成的链。

哈希算法，确保字符完全一致，能用来确保账本没有被篡改。一旦字符不一样了，区块的指针指向的位置就不一样了
 
智能合约，能执行智能合约就能执行一段代码，自动处理化的过程

### 区块链的种类：用户的不同导致的
公有链
联盟链
私人链

火币主要涉及的是公有链

### 比特币的诞生
随着时间的推移，挖矿的难度不同。
国内清退矿厂的时候，矿厂关了，挖矿难度低了；海外矿厂增加，难度又高了

### 行业的现状
币圈周期4年（受到比特币奖励减半机制的影响），股市6-7年

全球产业分布现状
原本中国很多，现在不多了

区块链是越来越好的

### 产业区块链
区块链技术应用到产业上
区块链很难篡改，能降低信任成本

我国，联盟链的形式应用区块链。虽然打击数字货币，但区块链还是要用的

### 以太坊
gas fee 付给矿工的手续费，有时成本高的离谱
pow的机制，要挖矿   pos的机制，不用老挖矿
TPS 吞吐量

### Layer2
以太坊是第一层，而在以太坊之上构建起来的可以叫 layer2

最主要的是 rollup
‒ ZK rollup
‒ 零知识证明技术，证明了有这个东西，但不展示这个东西
eg 有钥匙，但不以展示钥匙来证明，而是从房间拿一个东西
‒ 没有退出期，技术难度高
‒ optimistic rollup
‒ 有很差的推出期，提交一个东西，如果一直没有人反对，就执行
‒ 技术难度低

### NFT
同质化代币，数字，资产
交易平台 opensea ，数字艺术品
确权的作用

### GameFi
game+DeFi，在细分领域的投资是最多的
很多卡牌游戏
不是追求游戏体验，而是玩游戏可以赚钱，玩得越早赚的越多

